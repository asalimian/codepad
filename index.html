<!DOCTYPE html>
<html>

<head>
    <link rel="manifest" href="manifest.json">
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <style>
        body {
            height: 100vh;
            padding: 0;
            margin: 0;
        }

        #container {
            width: 100%;
            height: 90vh;
            padding: 0;
        }
        .dark-mode {
            background-color: black;
            color:white;
        }
        
    </style>
</head>

<body>
    <button onclick="saveFile()">ðŸ’¾</button>
    <button onclick="openFile()">ðŸ“‚</button>
    <button onclick="editMode()">Editor Mode</button>
    <button onclick="diffMode()">Compare Mode</button>
    <select name="language" id="language" onchange="setLang(this)">
        <option value="css">CSS</option>
        <option value="html">HTML</option>
        <option value="java">Java</option>
        <option value="javascript">Javascript</option>
        <option value="json">JSON</option>
        <option value="markdown">Markdown</option>
        <option value="python">Python</option>
        <option value="text">Text</option>
    </select>
    <button onclick="toggleTheme()" id="themeToggle" style="float:right;">ðŸŒž â†’ ðŸŒš</button>

    <div id="container" style="border:0px solid grey"></div>

    <script src="node_modules/monaco-editor/min/vs/loader.js"></script>
    <script>
        var text = ['function x() {', '\tconsole.log("Hello world!");', '}'].join('\n');
        require.config({
            paths: {
                vs: 'node_modules/monaco-editor/min/vs'
            }
        });
        require(['vs/editor/editor.main'], function () {
            var editor = monaco.editor.create(document.getElementById('container'), {
                value: text,
                language: userLanguage
            });
        });

        var userLanguage = 'javascript';

        var editor

        function setLang(lang) {
            userLanguage = lang.value;
            if (monaco.editor.getDiffEditors().length == 0) {
                normalMode()
            } else {
                diffMode()
            }
        }
        var lightTheme = true;
        function toggleTheme() {
            if (lightTheme) {
                monaco.editor.setTheme('vs-dark');
                document.getElementById('themeToggle').innerHTML = 'ðŸŒš â†’ ðŸŒž'
                lightTheme = false;

                var element = document.body;
                element.classList.toggle("dark-mode");
                const buttons = document.querySelectorAll('button');

                buttons.forEach(button => {
                button.classList.toggle('dark-mode');
                });
            } else {
                monaco.editor.setTheme('vs');
                document.getElementById('themeToggle').innerHTML = 'ðŸŒž â†’ ðŸŒš'
                lightTheme = true;
                var element = document.body;
                element.classList.toggle("dark-mode");
                const buttons = document.querySelectorAll('button');

                buttons.forEach(button => {
                button.classList.toggle('dark-mode');
                });
            }
        }
        function setEditors(textstream) {
            try {
                for (e of monaco.editor.getDiffEditors()) {
                    e.getOriginalEditor().setValue(textstream)
                    e.getModifiedEditor().setValue(textstream)
                }
                for (e of monaco.editor.getEditors()) {
                    e.setValue(textstream)
                }
            } catch (error) {
                console.log(error)
            }
        }
        function getEditors() {
            var textstream
            try {
                try {
                    oldEditor = monaco.editor.getDiffEditors()[0]
                    textstream = oldEditor.getModifiedEditor().getValue();
                } catch (error) {
                    oldEditor = monaco.editor.getEditors()[0]
                    textstream = oldEditor.getValue()
                }
                return textstream
            } catch (error) {
                console.log(error)
            }
        }

        function clearEditors() {
            try {

                for (e of monaco.editor.getDiffEditors()) {
                    e.dispose()
                }
                for (e of monaco.editor.getEditors()) {
                    e.dispose()
                }
            } catch (error) {
                console.log(error)
            }
        }

        function editMode() {

            clearEditors()

            require(['vs/editor/editor.main'], function () {
                var editor = monaco.editor.create(document.getElementById('container'), {
                    value: text,
                    language: userLanguage
                });
            });
        }
        function diffMode() {
            try {
                oldEditor = monaco.editor.getEditors()[0]
                text = oldEditor.getValue()
            } catch (error) {
                oldEditor = monaco.editor.getDiffEditors()[0]
                text = oldEditor.getModifiedEditor().getValue();
            }
            oldEditor.dispose()
            clearEditors()
            var originalModel = monaco.editor.createModel(text, userLanguage);
            var modifiedModel = monaco.editor.createModel(text, userLanguage);
            var diffEditor = monaco.editor.createDiffEditor(document.getElementById("container"), {
                originalEditable: true, // for left pane
                readOnly: false, // for right pane
            });
            diffEditor.setModel({ original: originalModel, modified: modifiedModel });
        }


        const pickerOpts = {
            types: [
                {
                    description: "Text",
                    accept: {
                        "text/*": [".txt", ".csv", ".log"]
                    }
                },
            ],
            excludeAcceptAllOption: true,
            multiple: false
        };

        async function openFile() { // Open file picker and destructure the result the first handle
            const [fileHandle] = await window.showOpenFilePicker(pickerOpts);

            // get file contents
            const fileData = await fileHandle.getFile();
            const fileText = await fileData.text();
            console.log(fileData)
            console.log(fileText)
            setEditors(fileText);
        }

        async function saveFile() { // create a new handle
            const opts = {
                types: [
                {
                    description: "Text file",
                    accept: { "text/plain": [".txt"] },
                },
                ],
            };
            const newHandle = await window.showSaveFilePicker(opts);

            // create a FileSystemWritableFileStream to write to
            const writableStream = await newHandle.createWritable();

            // write our file
            await writableStream.write(getEditors());

            // close the file and write the contents to disk.
            await writableStream.close();
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js', { scope: '/' });
        }
    </script>
</body>

</html>